<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ticket Dashboard</title>
  <style>
    :root {
      color-scheme: dark;
      --bg-main: radial-gradient(circle at top, #1d2537, #020617 60%);
      --bg-surface: rgba(15, 23, 42, 0.96);
      --bg-surface-soft: rgba(15, 23, 42, 0.9);
      --bg-sidebar: rgba(15, 23, 42, 0.98);
      --border-subtle: #111827;
      --border-strong: #1e293b;
      --accent: #4f46e5;
      --accent-soft: #6366f1;
      --text-main: #e5e7eb;
      --text-dim: #9ca3af;
      --text-muted: #6b7280;
      --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.55);
    }

    .theme-light {
      color-scheme: light;
      --bg-main: radial-gradient(circle at top, #eef2ff, #e5e7eb 55%);
      --bg-surface: rgba(255, 255, 255, 0.98);
      --bg-surface-soft: rgba(248, 250, 252, 0.98);
      --bg-sidebar: rgba(248, 250, 252, 0.98);
      --border-subtle: #d1d5db;
      --border-strong: #cbd5f5;
      --accent: #4f46e5;
      --accent-soft: #6366f1;
      --text-main: #111827;
      --text-dim: #4b5563;
      --text-muted: #6b7280;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.18);
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-main);
      color: var(--text-main);
      transition: background 0.3s ease, color 0.2s ease;
    }
    .layout {
      display: grid;
      grid-template-columns: 240px minmax(0, 1fr);
      min-height: 100vh;
    }
    .sidebar {
      background: var(--bg-sidebar);
      border-inline-end: 1px solid var(--border-subtle);
      padding: 16px 12px;
      box-shadow: 4px 0 18px rgba(0, 0, 0, 0.35);
      position: sticky;
      top: 0;
      max-height: 100vh;
      overflow-y: auto;
    }
    .sidebar h2 {
      font-size: 0.9rem;
      font-weight: 600;
      margin: 0 0 8px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .guild-list {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: calc(100vh - 80px);
      overflow-y: auto;
    }
    .guild-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      color: var(--text-main);
      border: 1px solid transparent;
    }
    .guild-item:hover {
      background: #020617;
      border-color: var(--border-strong);
    }
    .guild-item.active {
      background: linear-gradient(135deg, var(--accent), var(--accent-soft));
      border-color: transparent;
    }
    .guild-icon {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: #111827;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      color: #9ca3af;
      overflow: hidden;
    }
    .guild-icon img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .main {
      padding: 16px 18px 22px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    .header-title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .header-title h1 {
      margin: 0;
      font-size: 1.1rem;
    }
    .header-title span {
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid var(--border-strong);
      color: var(--text-dim);
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 16px;
    }
    .card {
      background: var(--bg-surface);
      border-radius: 12px;
      padding: 14px 14px 16px;
      border: 1px solid var(--border-subtle);
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 150px;
      box-shadow: var(--shadow-soft);
    }
    .card h3 {
      margin: 0;
      font-size: 0.9rem;
      color: #e5e7eb;
    }
    .card p {
      margin: 0;
      font-size: 0.78rem;
      color: #9ca3af;
    }
    label {
      font-size: 0.8rem;
      color: #9ca3af;
      display: block;
      margin-bottom: 4px;
    }
    select, textarea, input {
      width: 100%;
      border-radius: 8px;
      border: 1px solid var(--border-subtle);
      background: #020617;
      color: var(--text-main);
      padding: 7px 9px;
      font-size: 0.85rem;
    }
    select:focus, textarea:focus, input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent);
    }
    textarea {
      resize: vertical;
      min-height: 70px;
    }
    .footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-top: 4px;
    }
    button.primary {
      padding: 9px 18px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--accent), var(--accent-soft));
      color: white;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }
    button.primary:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .status {
      font-size: 0.78rem;
    }
    .status.ok { color: #4ade80; }
    .status.err { color: #f97373; }
    .status.info { color: var(--text-dim); }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 9px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid var(--border-subtle);
      font-size: 0.75rem;
      color: var(--text-dim);
    }
    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
    }
    .small {
      font-size: 0.76rem;
      color: var(--text-muted);
    }

    /* Ù¾Ø±ÛŒÙˆÛŒÙˆ Ù¾Ù†Ù„ ØªÛŒÚ©Øª */
    .preview-card {
      margin-top: 8px;
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      background: var(--bg-surface-soft);
      padding: 10px 12px 12px;
      font-size: 0.8rem;
      box-shadow: 0 14px 32px rgba(0, 0, 0, 0.35);
    }
    .preview-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .preview-avatar {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background: #111827;
    }
    .preview-author {
      font-size: 0.78rem;
      font-weight: 600;
    }
    .preview-content {
      margin-top: 4px;
      margin-bottom: 8px;
      font-size: 0.8rem;
      color: var(--text-main);
      white-space: pre-wrap;
    }
    .preview-actions {
      margin-top: 4px;
    }
    .preview-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 120px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #1f2937;
      color: #e5e7eb;
      font-size: 0.78rem;
    }

    /* Ø§Ø³ØªØ§Øª Ø¨Ø§Ù„Ø§ */
    .stats-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 8px;
    }
    .stat-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.8);
      font-size: 0.75rem;
      color: var(--text-dim);
    }
    .stat-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #4ade80;
    }

    .theme-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.7);
      font-size: 0.75rem;
      color: var(--text-dim);
      cursor: pointer;
    }
    .theme-toggle-icon {
      font-size: 0.9rem;
    }

    @media (max-width: 960px) {
      .layout {
        grid-template-columns: 1fr;
      }
      .sidebar {
        position: static;
        max-height: none;
        box-shadow: none;
        border-inline-end: none;
        border-bottom: 1px solid var(--border-subtle);
      }
      .main {
        padding: 14px 14px 24px;
      }
      .grid {
        grid-template-columns: minmax(0, 1fr);
      }
      .header {
        align-items: flex-start;
      }
    }

    @media (max-width: 600px) {
      .footer {
        flex-direction: column;
        align-items: stretch;
      }
      .footer .status {
        order: 2;
      }
      .footer button {
        order: 1;
        width: 100%;
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <h2>Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ Ø¨Ø§Øª</h2>
      <div id="guildList" class="guild-list small">
        <div>Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø³Ø±ÙˆØ±Ù‡Ø§...</div>
      </div>
    </aside>

    <main class="main">
      <div class="header">
        <div class="header-title">
          <h1 id="mainTitle">Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÛŒØ³ØªÙ… ØªÛŒÚ©Øª</h1>
          <span id="selectedGuildName">Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ø³Ø±ÙˆØ± Ø§Ø² Ù„ÛŒØ³Øª Ø³Ù…Øª Ú†Ù¾ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†.</span>
          <div class="stats-row">
            <div class="stat-chip"><span class="stat-dot"></span><span id="statGuildCount">0</span>&nbsp;Ø³Ø±ÙˆØ± Ù…ØªØµÙ„</div>
            <div class="stat-chip">ÙˆØ¶Ø¹ÛŒØª Ø¨Ø§Øª: <span id="statBotStatus">Ù†Ø§Ù…Ø´Ø®Øµ</span></div>
          </div>
        </div>
        <div class="badge" style="gap:8px;">
          <div class="theme-toggle" id="themeToggle">
            <span class="theme-toggle-icon" id="themeIcon">ğŸŒ™</span>
            <span id="themeLabel">Ø­Ø§Ù„Øª ØªÛŒØ±Ù‡</span>
          </div>
          <button id="tabTickets" class="primary" style="padding:4px 10px;font-size:0.78rem;">ØªÛŒÚ©Øªâ€ŒÙ‡Ø§</button>
          <button id="tabVoice" class="primary" style="padding:4px 10px;font-size:0.78rem;background:linear-gradient(135deg,#0f172a,#1f2937);">ÙˆÙˆÛŒØ³</button>
        </div>
      </div>

      <div id="ticketView">
        <div class="grid">
        <section class="card">
          <div>
            <h3>Ù…Ù‚ØµØ¯ Ù¾Ù†Ù„ ØªÛŒÚ©Øª</h3>
            <p>Ú†Ù†Ù„ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† Ú©Ù‡ Ù¾ÛŒØ§Ù… Ù¾Ù†Ù„ ØªÛŒÚ©Øª Ø¯Ø§Ø®Ù„ Ø¢Ù† Ø§Ø±Ø³Ø§Ù„ Ø´ÙˆØ¯.</p>
          </div>

          <div>
            <label for="panelChannelSelect">Ú†Ù†Ù„ Ù¾Ù†Ù„ (Ù…ØªÙ†ÛŒ)</label>
            <select id="panelChannelSelect" disabled>
              <option>Ø§ÙˆÙ„ ÛŒÚ© Ø³Ø±ÙˆØ± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†...</option>
            </select>
          </div>

          <div>
            <label for="ticketCategorySelect">Ú©ØªÚ¯ÙˆØ±ÛŒ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§</label>
            <select id="ticketCategorySelect" disabled>
              <option>Ø§ÙˆÙ„ ÛŒÚ© Ø³Ø±ÙˆØ± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†...</option>
            </select>
          </div>
        </section>

        <section class="card">
          <div>
            <h3>Ø¯Ø³ØªØ±Ø³ÛŒ Ùˆ Ø±ÙˆÙ„ Ø³Ø§Ù¾ÙˆØ±Øª</h3>
            <p>Ø±ÙˆÙ„ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† Ú©Ù‡ Ø§Ø¹Ø¶Ø§ÛŒ ØªÛŒÙ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø±ÙˆÛŒ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ù†Ø¯.</p>
          </div>

          <div>
            <label for="supportRoleSelect">Ø±ÙˆÙ„ Ø³Ø§Ù¾ÙˆØ±Øª</label>
            <select id="supportRoleSelect" disabled>
              <option>Ø§ÙˆÙ„ ÛŒÚ© Ø³Ø±ÙˆØ± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†...</option>
            </select>
          </div>

          <div class="small">
            Ù†Ú©ØªÙ‡: Ù‡Ù…Ù‡ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ ØµØ§Ø­Ø¨ ØªÛŒÚ©ØªØŒ Ø±ÙˆÙ„ Ø³Ø§Ù¾ÙˆØ±Øª Ùˆ Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§ÛŒ Ø¢Ù† Ú©ØªÚ¯ÙˆØ±ÛŒ Ù‚Ø§Ø¨Ù„ Ù…Ø´Ø§Ù‡Ø¯Ù‡â€ŒØ§Ù†Ø¯.
          </div>
        </section>

        <section class="card">
          <div>
            <h3>Ù…ØªÙ†â€ŒÙ‡Ø§ Ùˆ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§</h3>
            <p>Ù…ØªÙ† Ø¨Ø§Ù„Ø§ÛŒ Ù¾Ù†Ù„ Ùˆ Ù„ÛŒØ¨Ù„ Ø¯Ú©Ù…Ù‡ Ø±Ø§ Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒ Ú©Ù†.</p>
          </div>

          <div>
            <label for="panelMessage">Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ù¾Ù†Ù„</label>
            <textarea id="panelMessage" placeholder="Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª ØªÛŒÚ©Øª Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ± Ú©Ù„ÛŒÚ© Ú©Ù†."></textarea>
          </div>

          <div>
            <label for="buttonLabel">Ù…ØªÙ† Ø¯Ú©Ù…Ù‡ Ø³Ø§Ø®Øª ØªÛŒÚ©Øª</label>
            <input id="buttonLabel" placeholder="Ù…Ø«Ø§Ù„: Ø³Ø§Ø®Øª ØªÛŒÚ©Øª" />
          </div>

          <div class="preview-card">
            <div class="preview-header">
              <div class="preview-avatar"></div>
              <div>
                <div class="preview-author">Ticket Bot</div>
                <div class="small">Ø§Ú©Ù†ÙˆÙ† â€¢ Ø¯Ø± Ú†Ù†Ù„ Ù¾Ù†Ù„ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡</div>
              </div>
            </div>
            <div id="previewContent" class="preview-content">Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª ØªÛŒÚ©Øª Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ± Ú©Ù„ÛŒÚ© Ú©Ù†.</div>
            <div class="preview-actions">
              <button type="button" class="preview-button" id="previewButton">Ø³Ø§Ø®Øª ØªÛŒÚ©Øª</button>
            </div>
          </div>
        </section>
      </div>

      <div class="footer">
        <div id="status" class="status info">Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ø³Ø±ÙˆØ± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†.</div>
        <button id="sendBtn" class="primary" disabled>Ø§Ø±Ø³Ø§Ù„ Ù¾Ù†Ù„ ØªÛŒÚ©Øª Ø¯Ø± Ø¯ÛŒØ³Ú©ÙˆØ±Ø¯</button>
      </div>

      <div class="small">
        Ø±Ø§Ù‡Ù†Ù…Ø§: Ø¨Ø¹Ø¯ Ø§Ø² Ø§ÛŒÙ†Ú©Ù‡ Ù¾Ù†Ù„ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ø±Ø¯ÛŒØŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ØŒ ÛŒÚ© Ú†Ù†Ù„ ØªÛŒÚ©Øª Ø®ØµÙˆØµÛŒ Ø²ÛŒØ± Ú©ØªÚ¯ÙˆØ±ÛŒ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ Ù…ÛŒâ€ŒØ³Ø§Ø²Ù†Ø¯ Ùˆ Ø¢Ù†â€ŒØ¬Ø§ Ø¯Ú©Ù…Ù‡ Â«Ø¨Ø³ØªÙ† ØªÛŒÚ©ØªÂ» Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ø§Ø³Øª.
      </div>
      </div>

      <div id="voiceView" style="display:none;">
        <section class="card">
          <div>
            <h3>Ú©Ù†ØªØ±Ù„ ÙˆÙˆÛŒØ³ Ø¨Ø§Øª</h3>
            <p>Ú†Ù†Ù„ ÙˆÙˆÛŒØ³ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒ Ø¨Ø§Øª ÙˆØ§Ø±Ø¯ Ø¢Ù† Ø´ÙˆØ¯.</p>
          </div>

          <div>
            <label for="voiceChannelSelect">Ú†Ù†Ù„ ÙˆÙˆÛŒØ³</label>
            <select id="voiceChannelSelect" disabled>
              <option>Ø§ÙˆÙ„ ÛŒÚ© Ø³Ø±ÙˆØ± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†...</option>
            </select>
          </div>

          <div class="footer" style="margin-top:12px;padding:0;">
            <div id="voiceStatus" class="status info">Ø§Ø¨ØªØ¯Ø§ Ø³Ø±ÙˆØ± Ùˆ Ø³Ù¾Ø³ ÛŒÚ© Ú†Ù†Ù„ ÙˆÙˆÛŒØ³ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†.</div>
            <button id="moveVoiceBtn" class="primary" disabled>Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ø§Øª Ø¨Ù‡ Ø§ÛŒÙ† ÙˆÙˆÛŒØ³</button>
          </div>

          <div class="small">
            Ù†Ú©ØªÙ‡: Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¨Ø§Øª Ø¨ØªÙˆØ§Ù†Ø¯ ÙˆØ§Ø±Ø¯ ÙˆÙˆÛŒØ³ Ø´ÙˆØ¯ Ø¨Ø§ÛŒØ¯ Ù¾Ø±Ù…ÛŒØ´Ù† Connect Ùˆ Speak Ø±Ø§ Ø¯Ø± Ø¢Ù† Ú†Ù†Ù„ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯.
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const guildListEl = $("guildList");
    const statusEl = $("status");
    const selectedGuildNameEl = $("selectedGuildName");

    const panelChannelSelect = $("panelChannelSelect");
    const ticketCategorySelect = $("ticketCategorySelect");
    const supportRoleSelect = $("supportRoleSelect");
    const panelMessageInput = $("panelMessage");
    const buttonLabelInput = $("buttonLabel");
    const sendBtn = $("sendBtn");

    const previewContent = $("previewContent");
    const previewButton = $("previewButton");
    const themeToggle = $("themeToggle");
    const themeIcon = $("themeIcon");
    const themeLabel = $("themeLabel");
    const statGuildCount = $("statGuildCount");
    const statBotStatus = $("statBotStatus");

    const ticketView = $("ticketView");
    const voiceView = $("voiceView");
    const tabTickets = $("tabTickets");
    const tabVoice = $("tabVoice");
    const mainTitle = $("mainTitle");

    const voiceChannelSelect = $("voiceChannelSelect");
    const voiceStatusEl = $("voiceStatus");
    const moveVoiceBtn = $("moveVoiceBtn");

    let currentGuildId = null;
    let currentStructure = null;

    function setStatus(text, type = 'info') {
      statusEl.textContent = text;
      statusEl.className = `status ${type}`;
    }

    async function loadGuilds() {
      try {
        const res = await fetch('/api/guilds');
        const data = await res.json();

        guildListEl.innerHTML = '';

        if (!data.guilds || data.guilds.length === 0) {
          guildListEl.innerHTML = '<div>Ø¨Ø§Øª Ø¯Ø± Ù‡ÛŒÚ† Ø³Ø±ÙˆØ±ÛŒ Ø­Ø¶ÙˆØ± Ù†Ø¯Ø§Ø±Ø¯.</div>';
          return;
        }

        statGuildCount.textContent = data.guilds.length;
        statBotStatus.textContent = 'Ø¢Ù†Ù„Ø§ÛŒÙ†';

        data.guilds.forEach((g) => {
          const item = document.createElement('div');
          item.className = 'guild-item';
          item.dataset.id = g.id;

          const icon = document.createElement('div');
          icon.className = 'guild-icon';
          if (g.icon) {
            const img = document.createElement('img');
            img.src = g.icon;
            icon.appendChild(img);
          } else {
            icon.textContent = (g.name || '?')[0];
          }

          const name = document.createElement('div');
          name.textContent = g.name;

          item.appendChild(icon);
          item.appendChild(name);

          item.addEventListener('click', () => selectGuild(g.id, g.name, item));

          guildListEl.appendChild(item);
        });
      } catch (e) {
        guildListEl.innerHTML = '<div>Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø³Ø±ÙˆØ±Ù‡Ø§.</div>';
        statBotStatus.textContent = 'Ø®Ø·Ø§';
      }
    }

    async function selectGuild(id, name, element) {
      currentGuildId = id;
      currentStructure = null;

      document.querySelectorAll('.guild-item').forEach((el) => el.classList.remove('active'));
      element.classList.add('active');

      selectedGuildNameEl.textContent = `Ø³Ø±ÙˆØ± Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡: ${name}`;
      setStatus('Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ú†Ù†Ù„â€ŒÙ‡Ø§ Ùˆ Ø±ÙˆÙ„â€ŒÙ‡Ø§...', 'info');

      panelChannelSelect.disabled = true;
      ticketCategorySelect.disabled = true;
      supportRoleSelect.disabled = true;
      sendBtn.disabled = true;

      try {
        const res = await fetch(`/api/guilds/${id}/structure`);
        const data = await res.json();

        if (!res.ok) {
          setStatus(data.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø³Ø§Ø®ØªØ§Ø± Ø³Ø±ÙˆØ±.', 'err');
          return;
        }

        currentStructure = data;
        fillSelects();
        setStatus('Ø³Ø±ÙˆØ± Ù„ÙˆØ¯ Ø´Ø¯ØŒ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† Ùˆ Ø³Ù¾Ø³ Ù¾Ù†Ù„ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†.', 'ok');
      } catch (e) {
        setStatus('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±.', 'err');
      }
    }

    function fillSelects() {
      if (!currentStructure) return;

      const { channels, roles } = currentStructure;

      const textChannels = channels.filter((ch) => ch.type === 0);
      const categories = channels.filter((ch) => ch.type === 4);
      const voiceChannels = channels.filter((ch) => ch.type === 2);

      panelChannelSelect.innerHTML = '';
      ticketCategorySelect.innerHTML = '';
      supportRoleSelect.innerHTML = '';
      voiceChannelSelect.innerHTML = '';

      if (textChannels.length === 0) {
        const opt = document.createElement('option');
        opt.textContent = 'Ú†Ù†Ù„ Ù…ØªÙ†ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.';
        panelChannelSelect.appendChild(opt);
        panelChannelSelect.disabled = true;
      } else {
        textChannels.forEach((ch) => {
          const opt = document.createElement('option');
          opt.value = ch.id;
          opt.textContent = `#${ch.name}`;
          panelChannelSelect.appendChild(opt);
        });
        panelChannelSelect.disabled = false;
      }

      if (categories.length === 0) {
        const opt = document.createElement('option');
        opt.textContent = 'Ú©ØªÚ¯ÙˆØ±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.';
        ticketCategorySelect.appendChild(opt);
        ticketCategorySelect.disabled = true;
      } else {
        categories.forEach((ch) => {
          const opt = document.createElement('option');
          opt.value = ch.id;
          opt.textContent = ch.name;
          ticketCategorySelect.appendChild(opt);
        });
        ticketCategorySelect.disabled = false;
      }

      if (!roles || roles.length === 0) {
        const opt = document.createElement('option');
        opt.textContent = 'Ø±ÙˆÙ„ Ø³Ø§Ù¾ÙˆØ±Øª ÛŒØ§ÙØª Ù†Ø´Ø¯.';
        supportRoleSelect.appendChild(opt);
        supportRoleSelect.disabled = true;
      } else {
        roles.forEach((r) => {
          const opt = document.createElement('option');
          opt.value = r.id;
          opt.textContent = r.name;
          supportRoleSelect.appendChild(opt);
        });
        supportRoleSelect.disabled = false;
      }

      if (voiceChannels.length === 0) {
        const opt = document.createElement('option');
        opt.textContent = 'Ú†Ù†Ù„ ÙˆÙˆÛŒØ³ ÛŒØ§ÙØª Ù†Ø´Ø¯.';
        voiceChannelSelect.appendChild(opt);
        voiceChannelSelect.disabled = true;
        moveVoiceBtn.disabled = true;
      } else {
        voiceChannels.forEach((ch) => {
          const opt = document.createElement('option');
          opt.value = ch.id;
          opt.textContent = `ğŸ”Š ${ch.name}`;
          voiceChannelSelect.appendChild(opt);
        });
        voiceChannelSelect.disabled = false;
        moveVoiceBtn.disabled = !voiceChannelSelect.value;
      }

      sendBtn.disabled = !(
        panelChannelSelect.value &&
        ticketCategorySelect.value &&
        supportRoleSelect.value
      );
    }

    panelChannelSelect.addEventListener('change', () => {
      if (currentStructure) {
        sendBtn.disabled = !(
          panelChannelSelect.value &&
          ticketCategorySelect.value &&
          supportRoleSelect.value
        );
      }
    });
    ticketCategorySelect.addEventListener('change', () => {
      if (currentStructure) {
        sendBtn.disabled = !(
          panelChannelSelect.value &&
          ticketCategorySelect.value &&
          supportRoleSelect.value
        );
      }
    });
    supportRoleSelect.addEventListener('change', () => {
      if (currentStructure) {
        sendBtn.disabled = !(
          panelChannelSelect.value &&
          ticketCategorySelect.value &&
          supportRoleSelect.value
        );
      }
    });

    sendBtn.addEventListener('click', async () => {
      if (!currentGuildId) return;

      setStatus('Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ù¾Ù†Ù„...', 'info');
      sendBtn.disabled = true;

      const payload = {
        guildId: currentGuildId,
        panelChannelId: panelChannelSelect.value,
        ticketCategoryId: ticketCategorySelect.value,
        supportRoleId: supportRoleSelect.value,
        panelMessage: panelMessageInput.value.trim() || 'Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª ØªÛŒÚ©Øª Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ± Ú©Ù„ÛŒÚ© Ú©Ù†.',
        buttonLabel: buttonLabelInput.value.trim() || 'Ø³Ø§Ø®Øª ØªÛŒÚ©Øª',
      };

      try {
        const res = await fetch('/create-panel', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        const data = await res.json();
        if (res.ok) {
          setStatus(data.message || 'Ù¾Ù†Ù„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.', 'ok');
        } else {
          setStatus(data.error || 'Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯.', 'err');
        }
      } catch (e) {
        setStatus('Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†Ø´Ø¯.', 'err');
      } finally {
        sendBtn.disabled = false;
      }
    });

    moveVoiceBtn.addEventListener('click', async () => {
      if (!currentGuildId || !voiceChannelSelect.value) return;

      voiceStatusEl.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„ Ø¨Ø§Øª Ø¨Ù‡ ÙˆÙˆÛŒØ³...';
      voiceStatusEl.className = 'status info';
      moveVoiceBtn.disabled = true;

      try {
        const res = await fetch('/voice/join', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            guildId: currentGuildId,
            voiceChannelId: voiceChannelSelect.value,
          }),
        });

        const data = await res.json();
        if (res.ok) {
          voiceStatusEl.textContent = data.message || 'Ø¨Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ ÙˆÙˆÛŒØ³ Ù…ØªØµÙ„ Ø´Ø¯.';
          voiceStatusEl.className = 'status ok';
        } else {
          voiceStatusEl.textContent = data.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ ÙˆÙˆÛŒØ³.';
          voiceStatusEl.className = 'status err';
        }
      } catch (e) {
        voiceStatusEl.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ù¾Ù†Ù„.';
        voiceStatusEl.className = 'status err';
      } finally {
        moveVoiceBtn.disabled = !voiceChannelSelect.value;
      }
    });

    // Ù¾Ø±ÛŒÙˆÛŒÙˆ Ø²Ù†Ø¯Ù‡ Ù…ØªÙ† Ù¾Ù†Ù„ Ùˆ Ø¯Ú©Ù…Ù‡
    function updatePreview() {
      previewContent.textContent = panelMessageInput.value.trim() || 'Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª ØªÛŒÚ©Øª Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ± Ú©Ù„ÛŒÚ© Ú©Ù†.';
      previewButton.textContent = buttonLabelInput.value.trim() || 'Ø³Ø§Ø®Øª ØªÛŒÚ©Øª';
    }
    panelMessageInput.addEventListener('input', updatePreview);
    buttonLabelInput.addEventListener('input', updatePreview);

    // ØªÙ… ØªÛŒØ±Ù‡/Ø±ÙˆØ´Ù† Ø¨Ø§ localStorage
    function applyTheme(theme) {
      if (theme === 'light') {
        document.documentElement.classList.add('theme-light');
        themeIcon.textContent = 'â˜€ï¸';
        themeLabel.textContent = 'Ø­Ø§Ù„Øª Ø±ÙˆØ´Ù†';
      } else {
        document.documentElement.classList.remove('theme-light');
        themeIcon.textContent = 'ğŸŒ™';
        themeLabel.textContent = 'Ø­Ø§Ù„Øª ØªÛŒØ±Ù‡';
      }
    }

    const savedTheme = localStorage.getItem('ticketPanelTheme') || 'dark';
    applyTheme(savedTheme);

    themeToggle.addEventListener('click', () => {
      const current = document.documentElement.classList.contains('theme-light') ? 'light' : 'dark';
      const next = current === 'light' ? 'dark' : 'light';
      localStorage.setItem('ticketPanelTheme', next);
      applyTheme(next);
    });

    // Ø³ÙˆÛŒÛŒÚ† Ø¨ÛŒÙ† ØªØ¨ ØªÛŒÚ©Øª Ùˆ ÙˆÙˆÛŒØ³
    function activateTab(tab) {
      if (tab === 'tickets') {
        ticketView.style.display = '';
        voiceView.style.display = 'none';
        mainTitle.textContent = 'Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÛŒØ³ØªÙ… ØªÛŒÚ©Øª';
        tabTickets.style.background = 'linear-gradient(135deg, var(--accent), var(--accent-soft))';
        tabVoice.style.background = 'linear-gradient(135deg,#0f172a,#1f2937)';
      } else {
        ticketView.style.display = 'none';
        voiceView.style.display = '';
        mainTitle.textContent = 'Ú©Ù†ØªØ±Ù„ ÙˆÙˆÛŒØ³ Ø¨Ø§Øª';
        tabVoice.style.background = 'linear-gradient(135deg, var(--accent), var(--accent-soft))';
        tabTickets.style.background = 'linear-gradient(135deg,#0f172a,#1f2937)';
      }
    }

    tabTickets.addEventListener('click', () => activateTab('tickets'));
    tabVoice.addEventListener('click', () => activateTab('voice'));

    // Ø´Ø±ÙˆØ¹
    loadGuilds();
    updatePreview();
    activateTab('tickets');
  </script>
</body>
</html>
